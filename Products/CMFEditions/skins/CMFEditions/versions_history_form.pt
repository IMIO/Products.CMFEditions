<html metal:use-macro="here/main_template/macros/master" i18n:domain="plone">

  <tal:block metal:fill-slot="head_slot">
        <link rel="stylesheet" type="text/css" href="compare.css" />
  </tal:block>

  <div metal:fill-slot="main"
       tal:define="pr nocall:here/portal_repository;
                   history python:pr.getHistory(here)">


    <h1>History of
          <span tal:content="here/title_or_id">title</span>
    </h1>

    <div>
        <span i18n:translate="box_last_modified">
          Last modified
        </span>
        <span tal:replace="python:here.toLocalizedTime(here.ModificationDate(),long_format=1)"
              tal:on-error="string:-" >
          August 16, 2001 at 23:35:59
        </span>
    </div>

    <form action="."
        method="post"
        tal:condition="python: history"
        tal:attributes="action string:$here_url/versions_history">

        <table id="sortable"
                class="listing"
                summary="Content history"
                cellpadding="0" cellspacing="0"
                >

            <thead>

                <tr>
                  <th><tal:title i18n:translate="listingheader_key"
                      >version</tal:title></th>
                  <th><tal:title i18n:translate="listingheader_datetime"
                      >created</tal:title></th>
                  <th><tal:title i18n:translate="listingheader_user"
                      >user</tal:title></th>
                  <th><tal:title i18n:translate="listingheader_comment"
                      >comment</tal:title></th>
                  <th><tal:title i18n:translate="listingheader_actions"
                      >actions</tal:title></th>
                </tr>
            </thead>

            <tbody>
                <tal:block repeat="vdata history">
                <tr tal:define="id string:${vdata/version_id};
                                current python:pr.isUpToDate(here,id);">
                  <td>
                    <span tal:content="id">1</span>
                    <a href="#"
                       class="version-table-version"
                       tal:condition="not:current"
                       tal:attributes="href string:$here_url/versions_history_form?version_id=${id}">
                       (show)</a>
                  </td>
                  <td>
                    <span tal:content="python:here.toLocalizedTime(vdata.sys_metadata['timestamp'],long_format=1)">2004/10/21 03:15 PM</span>
                  </td>
                  <td>
                    <span tal:content="vdata/sys_metadata/principal">fciriaci</span>
                  </td>
                  <td><span tal:content="vdata/comment">Draft version ready for comments from the group.</span>
                  </td>
                  <td>
                    <ul>
                        <tal:diffs condition="exists:here/portal_diff">
                        <li tal:condition="not:current">
                            <a href=""
                               style="text-decoration: none"
                               tal:attributes="href string:$here_url/version_diff?version_id1=current&version_id2=${id}">
                            Diff to current
                            </a>
                        </li>
                        <li tal:condition="not:repeat/vdata/start">
                            <a href=""
                               style="text-decoration: none"
                               tal:define="prev_ver python:str(int(id)-1)"
                               tal:attributes="href string:$here_url/version_diff?version_id1=${id}&version_id2=${prev_ver}">
                            Diff from last
                            </a>
                        </li>
                        </tal:diffs>
                        <li tal:condition="not:current">
                            <a href=""
                               style="text-decoration: none"
                               tal:attributes="href string:$here_url/rollbackversion?version_id=${id}">
                        rollback
                            </a>
                        </li>
                    </ul>
                  </td>
                </tr>
                </tal:block>
            </tbody>
          </table>

    </form>

    <form action="#"
        method="post"
        tal:attributes="action string:$here_url/saveasnewversion">

        <fieldset>

            <div class="field">
              <label for="description"
                    i18n:translate="label_newversion">New version</label>

              <div class="formHelp" i18n:translate="help_versioncomment">
                At any moment you can save the content you just edited as a new version. Enter below a comment to identify the version and hit the "Save as new version" button.
              </div>
              <textarea cols="60"
                        rows="3"
                        tabindex=""
                        id="versioncomment"
                        name="versioncomment"
                        >Insert a comment.</textarea>
            </div>

            <input class="context"
                        type="submit"
                        name="saveversion"
                        value="Save as a new version"
                        tabindex=""
                        />

        </fieldset>

    </form>

    <div style="border:solid 1px gray"
         tal:define="version_id python:request.get('version_id', None);"
         tal:condition="version_id">
      <tal:block define="vdata python:pr.retrieve(here,version_id);
                         version_view_macro python: here.get_macros(version_id);"
>

        <h1>Version <b tal:content="version_id">0</b></h1>

        <tal:block define="here nocall:vdata/object;
                           portal_type python:here.getPortalTypeName().lower().replace(' ', '_');
                           view_macro python:version_view_macro;">
              <metal:use_body use-macro="view_macro" />
        </tal:block>
    </tal:block>
  </div>

  </div>
</html>

